<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .product-list {
            margin-top: 2rem;
        }
        .product-item {
            background: #f8f9fa;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin: 0.5rem;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 产品同步测试页面</h1>
        
        <div class="status info">
            <strong>测试说明：</strong> 此页面用于测试管理后台与前端的产品数据同步功能
        </div>
        
        <div class="status" id="syncStatus">
            正在检查产品数据...
        </div>
        
        <div>
            <button class="btn" onclick="refreshProducts()">🔄 刷新产品列表</button>
            <button class="btn btn-success" onclick="addTestProduct()">➕ 添加测试产品</button>
            <button class="btn btn-danger" onclick="clearTestProducts()">🗑️ 清除测试产品</button>
        </div>
        
        <div class="product-list">
            <h3>当前产品列表：</h3>
            <div id="productList">
                加载中...
            </div>
        </div>
        
        <div class="status info">
            <strong>测试步骤：</strong><br>
            1. 点击"添加测试产品"添加一个测试产品<br>
            2. 打开管理后台 <a href="admin.html" target="_blank">admin.html</a><br>
            3. 在管理后台添加/编辑产品<br>
            4. 返回此页面查看是否实时更新<br>
            5. 打开主页面 <a href="index.html" target="_blank">index.html</a> 查看产品是否同步
        </div>
    </div>

    <script>
        let products = [];
        let lastUpdateTime = null;

        // 加载产品数据
        function loadProducts() {
            const savedProducts = localStorage.getItem('adminProducts');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
                lastUpdateTime = new Date().toLocaleTimeString();
                updateSyncStatus('success', `产品数据已加载 (${products.length} 个产品) - 更新时间: ${lastUpdateTime}`);
            } else {
                products = [];
                updateSyncStatus('warning', '未找到产品数据');
            }
            renderProducts();
        }

        // 更新同步状态
        function updateSyncStatus(type, message) {
            const status = document.getElementById('syncStatus');
            status.className = `status ${type}`;
            status.innerHTML = `<strong>状态：</strong> ${message}`;
        }

        // 渲染产品列表
        function renderProducts() {
            const productList = document.getElementById('productList');
            if (products.length === 0) {
                productList.innerHTML = '<div class="status warning">暂无产品数据</div>';
                return;
            }

            let html = '';
            products.forEach(product => {
                html += `
                    <div class="product-item">
                        <strong>${product.title}</strong> - ¥${product.price.toLocaleString()}<br>
                        <small>${product.description}</small>
                        <div class="timestamp">ID: ${product.id} | 类别: ${product.category}</div>
                    </div>
                `;
            });
            productList.innerHTML = html;
        }

        // 刷新产品
        function refreshProducts() {
            loadProducts();
        }

        // 添加测试产品
        function addTestProduct() {
            const testProduct = {
                id: Date.now(),
                title: `测试产品 ${new Date().toLocaleTimeString()}`,
                description: '这是一个测试产品，用于验证同步功能',
                price: Math.floor(Math.random() * 1000) + 100,
                image: '🧪',
                category: '测试产品',
                stock: 10,
                createdAt: new Date().toISOString()
            };
            
            products.push(testProduct);
            localStorage.setItem('adminProducts', JSON.stringify(products));
            
            // 触发同步事件
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'adminProducts',
                newValue: JSON.stringify(products)
            }));
            
            loadProducts();
            updateSyncStatus('success', '测试产品已添加并同步');
        }

        // 清除测试产品
        function clearTestProducts() {
            if (confirm('确定要清除所有测试产品吗？')) {
                products = products.filter(p => p.category !== '测试产品');
                localStorage.setItem('adminProducts', JSON.stringify(products));
                
                // 触发同步事件
                window.dispatchEvent(new StorageEvent('storage', {
                    key: 'adminProducts',
                    newValue: JSON.stringify(products)
                }));
                
                loadProducts();
                updateSyncStatus('info', '测试产品已清除');
            }
        }

        // 监听Local Storage变化
        window.addEventListener('storage', function(e) {
            if (e.key === 'adminProducts') {
                updateSyncStatus('info', '检测到数据变化，正在更新...');
                setTimeout(() => {
                    loadProducts();
                }, 500);
            }
        });

        // 定期检查数据变化
        setInterval(() => {
            const savedProducts = localStorage.getItem('adminProducts');
            if (savedProducts) {
                const currentProducts = JSON.parse(savedProducts);
                if (JSON.stringify(currentProducts) !== JSON.stringify(products)) {
                    updateSyncStatus('info', '检测到数据变化，正在更新...');
                    loadProducts();
                }
            }
        }, 2000);

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
        });
    </script>
</body>
</html>
